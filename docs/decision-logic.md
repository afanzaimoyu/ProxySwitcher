# 代理决策与防抖算法说明

本文档详细说明 ProxySwitcher 如何从网络状态推导出代理开关决策，以及防抖机制的实现思路。

---

## 一、问题背景

网络状态存在大量瞬时变化，例如：

- 网线插拔瞬间
- Wi-Fi 重连
- DHCP 地址切换
- 虚拟网卡短暂上线

如果每次变化都立即切换代理，会导致：

- 代理频繁抖动
- 系统状态不稳定
- 网络体验变差

---

## 二、状态机模型

核心状态变量：

- `lastState`：已确认并生效的代理状态
- `pendingState`：当前观察到的候选状态
- `consecutiveCount`：候选状态连续出现次数

---

## 三、决策流程

每次心跳周期内：

1. 根据网络快照计算 `currentState`
2. 如果 `currentState == lastState`
    - 重置候选状态
    - 不做任何操作
3. 如果 `currentState != lastState`
    - 与 `pendingState` 比较
    - 若一致，`consecutiveCount++`
    - 若不一致，重置计数
4. 当 `consecutiveCount >= 阈值`
    - 执行代理切换
    - 更新 `lastState`

---

## 四、防抖的意义

该机制可以有效避免：

- 瞬时网络抖动
- 插拔过程中的误判
- 多网卡竞争导致的来回切换

这是一个典型的**稳定性优先设计**。

---

## 五、环境判定策略（当前实现）

当前版本规则为：

- 存在外部 Wi-Fi（非 10.x） → 关闭代理
- 否则，如存在内网有线网 → 开启代理
- 其他情况 → 关闭代理

该策略集中在 `evaluateEnvironment()` 中，后续可配置化。

---

## 六、设计原则总结

- 宁可慢一拍，也不误判
- 状态必须可追溯
- 决策逻辑集中、可替换

这也是未来支持配置文件和多规则的基础。
